name: Deploy Staging on PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  deploy-staging:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            pub-${{ runner.os }}-

      - name: Flutter pub get
        run: flutter pub get

      - name: Build Flutter Web
        run: flutter build web --release --pwa-strategy=none

      - name: Deploy to Firebase Hosting (staging)
        uses: w9jds/firebase-action@v2.2.0
        with:
          args: deploy --only hosting:portfolio-76903-staging --project portfolio-76903 --force
        env:
          GCP_SA_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      - name: Replace preview URL comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const url = "https://staging.yannlocatelli.fr";
            const marker = "ðŸš€ Preview staging";

            // Liste tous les commentaires de la PR
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
            });

            // Supprime les anciens commentaires de preview
            const previews = comments.filter(c => c.body.includes(marker));

            for (const comment of previews) {
              await github.rest.issues.deleteComment({
                owner,
                repo,
                comment_id: comment.id,
              });
            }

            // CrÃ©e un nouveau commentaire
            const body = `${marker} disponible :\n\nðŸ‘‰ ${url}`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body,
            });
